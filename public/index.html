<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockUp - AI-Powered Live Stock Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding-bottom: 120px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #f1f5f9;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #94a3b8;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            border-radius: 20px;
            padding: 8px 16px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #10b981;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .api-status {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #334155;
            transition: all 0.5s ease;
            border-left: 4px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .success-check {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #10b981;
            border-radius: 50%;
            position: relative;
            margin-right: 10px;
        }

        .success-check::after {
            content: '✓';
            position: absolute;
            color: white;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border-color: rgba(100, 255, 218, 0.2);
        }

        .card h2 {
            color: #f1f5f9;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #475569;
            padding-bottom: 10px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #475569;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
        }

        .search-input:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .search-btn:disabled {
            background: #475569;
            color: #64748b;
            cursor: not-allowed;
        }

        .stock-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #64ffda;
            transition: all 0.3s ease;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .stock-item:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateX(5px);
            border-color: rgba(100, 255, 218, 0.5);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stock-symbol {
            font-weight: bold;
            font-size: 1.1rem;
            color: #f1f5f9;
        }

        .stock-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #64ffda;
        }

        .stock-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .status-positive {
            color: #10b981;
        }

        .status-negative {
            color: #ef4444;
        }

        .status-neutral {
            color: #64ffda;
        }

        .ai-search-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(100, 255, 218, 0.3);
            padding: 20px;
            z-index: 1000;
        }

        .ai-search-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 25px;
            padding: 8px;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        .ai-search-icon {
            font-size: 24px;
            padding: 0 15px;
            color: #64ffda;
        }

        .ai-search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #e2e8f0;
            font-size: 16px;
            outline: none;
        }

        .ai-search-input::placeholder {
            color: #94a3b8;
        }

        .ai-search-btn {
            background: linear-gradient(45deg, #64ffda, #00bcd4);
            border: none;
            border-radius: 20px;
            padding: 15px 30px;
            color: #0f172a;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .ai-search-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.4);
        }

        .ai-search-btn:disabled {
            background: #475569;
            color: #64748b;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            color: #64ffda;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #475569;
            border-top: 3px solid #64ffda;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
            margin-bottom: 15px;
        }

        .data-source-indicator {
            font-size: 0.8rem;
            color: #64748b;
            text-align: right;
            margin-top: 10px;
        }

        .real-data {
            color: #10b981;
        }

        .simulated-data {
            color: #f59e0b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .stock-details {
                grid-template-columns: 1fr;
            }

            .ai-search-container {
                flex-direction: column;
                padding: 15px;
            }

            .ai-search-input {
                margin: 10px 0;
                padding: 12px 15px;
                border-radius: 15px;
                background: rgba(15, 23, 42, 0.9);
                border: 1px solid rgba(100, 255, 218, 0.2);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌙 StockUp</h1>
            <p>Live AI-powered stock intelligence with real-time market data</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Live Market Intelligence</span>
            </div>
        </div>

        <div id="apiStatus" class="api-status">
            <div class="success-check"></div>
            ✅ Connected to live market data sources (Polygon.io + NewsAPI + OpenAI)
        </div>

        <div class="main-content">
            <div class="card">
                <h2>🔍 Live Stock Analysis</h2>
                <div class="search-container">
                    <input type="text" id="stockSearch" class="search-input" placeholder="Enter any stock symbol (e.g., AAPL, TSLA, NVDA)">
                    <button id="searchBtn" class="search-btn">Analyze</button>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>

        <div class="card full-width">
            <h2>📊 Your Live Watchlist</h2>
            <div id="watchlist"></div>
        </div>
    </div>

    <div class="ai-search-bar">
        <div class="ai-search-container">
            <div class="ai-search-icon">🤖</div>
            <input 
                type="text" 
                id="aiSearchInput" 
                class="ai-search-input" 
                placeholder="Ask AI: What's happening with Apple today? Should I buy Tesla now? Latest market trends?"
            >
            <button id="askAIBtn" class="ai-search-btn">Ask AI</button>
        </div>
    </div>

    <script>
        let watchlist = [];
        let currentModal = null;
        
        // API Configuration
        const API_BASE = '/api';

        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlist();
            
            // Add event listeners
            document.getElementById('aiSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') askLiveAI();
            });
            
            document.getElementById('stockSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchLiveStock();
            });

            document.getElementById('searchBtn').addEventListener('click', searchLiveStock);
            document.getElementById('askAIBtn').addEventListener('click', askLiveAI);

            // Refresh watchlist every 30 seconds
            setInterval(refreshWatchlist, 30000);
        });

        async function searchLiveStock() {
            const symbol = document.getElementById('stockSearch').value.toUpperCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            const searchBtn = document.getElementById('searchBtn');

            if (!symbol) {
                resultsDiv.innerHTML = '<div class="error-message">Please enter a stock symbol</div>';
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'Analyzing...';
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching live market data from Polygon.io...</div>';

            try {
                const stockResponse = await fetch(`${API_BASE}/stock/${symbol}`);
                const stockData = await stockResponse.json();

                if (stockData.error) {
                    throw new Error(stockData.error);
                }

                displayLiveStockResult(stockData, resultsDiv);
                
            } catch (error) {
                console.error('Stock search error:', error);
                resultsDiv.innerHTML = `<div class="error-message">Error fetching stock data: ${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Analyze';
            }
        }

        function displayLiveStockResult(stock, container) {
            const changeClass = stock.change >= 0 ? 'status-positive' : 'status-negative';
            const changeSymbol = stock.change >= 0 ? '+' : '';
            const signal = getLiveStockSignal(stock);
            const dataSourceClass = stock.source === 'polygon.io' ? 'real-data' : 'simulated-data';
            const dataSourceText = stock.source === 'polygon.io' ? '🔴 Live data from Polygon.io' : '🟡 Simulated data (API limit reached)';

            container.innerHTML = `
                <div class="stock-item">
                    <div class="stock-header">
                        <span class="stock-symbol">${stock.symbol}</span>
                        <span class="stock-price">$${stock.price.toFixed(2)}</span>
                    </div>
                    <p style="margin-bottom: 10px; color: #94a3b8; font-weight: 500;">${stock.name}</p>
                    <div class="stock-details">
                        <div>Change: <span class="${changeClass}">${changeSymbol}$${stock.change.toFixed(2)}</span></div>
                        <div>Change %: <span class="${changeClass}">${changeSymbol}${stock.changePercent.toFixed(2)}%</span></div>
                        <div>Volume: ${formatNumber(stock.volume)}</div>
                        <div>Market Cap: ${stock.marketCap || 'N/A'}</div>
                        <div>High: $${stock.high.toFixed(2)}</div>
                        <div>Low: $${stock.low.toFixed(2)}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div style="background: rgba(15, 23, 42, 0.6); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: ${signal.class === 'status-positive' ? '#10b981' : signal.class === 'status-negative' ? '#ef4444' : '#64ffda'};">
                                ${signal.text}
                            </div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">AI Signal</div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.6); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #f1f5f9;">65.2</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">RSI</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="addToWatchlist('${stock.symbol}', ${stock.price})" class="btn btn-primary">Add to Watchlist</button>
                        <button onclick="getLiveAnalysis('${stock.symbol}')" class="btn btn-secondary">Get AI Analysis</button>
                    </div>
                    
                    <div class="data-source-indicator ${dataSourceClass}">
                        ${dataSourceText} • Last updated: ${new Date(stock.lastUpdated).toLocaleTimeString()}
                    </div>
                </div>
            `;
        }

        async function askLiveAI() {
            const input = document.getElementById('aiSearchInput');
            const btn = document.getElementById('askAIBtn');
            const query = input.value.trim();
            
            if (!query) {
                showNotification('Please enter a question for the AI!', 'warning');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Analyzing with OpenAI...';
            
            try {
                const stockSymbol = extractStockSymbol(query);
                let stockData = null;
                let newsData = null;

                if (stockSymbol) {
                    try {
                        const stockResponse = await fetch(`${API_BASE}/stock/${stockSymbol}`);
                        stockData = await stockResponse.json();
                        
                        const newsResponse = await fetch(`${API_BASE}/news/${stockSymbol}`);
                        newsData = await newsResponse.json();
                    } catch (error) {
                        console.error('Error fetching data for AI analysis:', error);
                    }
                }

                const aiResponse = await fetch(`${API_BASE}/ai-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        stockData: stockData,
                        newsData: newsData
                    })
                });

                const aiData = await aiResponse.json();

                if (aiData.error) {
                    throw new Error(aiData.error);
                }

                showAIAnalysisModal(query, aiData, stockData, newsData);
                
            } catch (error) {
                console.error('AI analysis error:', error);
                showNotification('AI analysis temporarily unavailable. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ask AI';
                input.value = '';
            }
        }

        function showAIAnalysisModal(query, aiData, stockData, newsData) {
            const structured = aiData.structured;
            const isOpenAI = aiData.source === 'openai';
            const apiIndicator = isOpenAI ? '🔴 OpenAI GPT-3.5-Turbo' : '🟡 Rule-based analysis (API limit reached)';
            
            const analysis = `
                <div style="background: linear-gradient(45deg, #64ffda, #00bcd4); color: #0f172a; padding: 25px; border-radius: 20px 20px 0 0; text-align: center;">
                    <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">🤖 ${isOpenAI ? 'Live AI Analysis' : 'Smart Analysis'}</h2>
                    <p style="margin: 0; opacity: 0.8;">${isOpenAI ? 'Powered by OpenAI GPT-3.5-Turbo' : 'Intelligent rule-based analysis'}</p>
                </div>
                
                <div style="padding: 30px; color: #e2e8f0;">
                    <div style="background: rgba(100, 255, 218, 0.1); border-left: 4px solid #64ffda; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <div style="font-size: 1.1rem; color: #64ffda; font-weight: 600;">"${query}"</div>
                        <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 10px;">🟢 Analysis generated: ${new Date().toLocaleTimeString()}</div>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, ${structured.color}20, ${structured.color}10); border: 2px solid ${structured.color}; border-radius: 15px; padding: 25px; margin-bottom: 30px; position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; font-size: 2rem; opacity: 0.3;">${structured.icon}</div>
                        <h3 style="color: ${structured.color}; margin: 0 0 15px 0; font-size: 1.3rem;">🎯 AI Recommendation</h3>
                        <div style="background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 20px; border-left: 4px solid ${structured.color};">
                            <div style="font-size: 1.4rem; font-weight: bold; color: ${structured.color}; margin-bottom: 12px;">
                                ${structured.recommendation}
                            </div>
                            <div style="font-size: 0.9rem; color: #94a3b8;">
                                Confidence Level: <span style="color: ${structured.color}; font-weight: 600;">${structured.confidence}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 25px; margin-bottom: 25px; border-left: 4px solid #8b5cf6;">
                        <h3 style="color: #8b5cf6; margin: 0 0 15px 0;">📊 Detailed Analysis</h3>
                        <div style="font-size: 0.95rem; color: #e2e8f0; line-height: 1.6; white-space: pre-wrap;">
                            ${aiData.analysis}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        ${stockData ? `<button onclick="addToWatchlist('${stockData.symbol}', ${stockData.price}); closeModal();" style="background: linear-gradient(45deg, #10b981, #059669); border: none; color: white; padding: 15px 40px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px; margin-right: 10px;">+ Add to Watchlist</button>` : ''}
                        <button onclick="closeModal();" style="background: linear-gradient(45deg, #64ffda, #00bcd4); border: none; color: #0f172a; padding: 15px 40px; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 16px;">Close</button>
                    </div>
                    
                    <div style="background: rgba(251, 146, 60, 0.1); border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-top: 30px; text-align: center;">
                        🤖 <strong>${apiIndicator}</strong> • ${isOpenAI ? `Tokens used: ${aiData.tokensUsed}` : 'Using intelligent rule-based analysis'} • Generated: ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            showModal(analysis);
        }

        function getLiveStockSignal(stock) {
            let score = 0;
            
            if (stock.changePercent > 3) score += 2;
            else if (stock.changePercent > 1) score += 1;
            else if (stock.changePercent < -3) score -= 2;
            else if (stock.changePercent < -1) score -= 1;
            
            if (stock.volume > 30000000) score += 0.5;
            
            if (score >= 2) return { text: 'Strong Buy', class: 'status-positive' };
            if (score >= 1) return { text: 'Buy', class: 'status-positive' };
            if (score <= -2) return { text: 'Strong Sell', class: 'status-negative' };
            if (score <= -1) return { text: 'Sell', class: 'status-negative' };
            return { text: 'Hold', class: 'status-neutral' };
        }

        function formatNumber(num) {
            if (!num) return 'N/A';
            const number = parseInt(num);
            if (number >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            }
            return number.toLocaleString();
        }

        function extractStockSymbol(query) {
            const words = query.toUpperCase().split(/\s+/);
            
            const stockMappings = {
                'AAPL': 'AAPL', 'APPLE': 'AAPL',
                'MSFT': 'MSFT', 'MICROSOFT': 'MSFT',
                'GOOGL': 'GOOGL', 'GOOGLE': 'GOOGL', 'ALPHABET': 'GOOGL',
                'TSLA': 'TSLA', 'TESLA': 'TSLA',
                'AMZN': 'AMZN', 'AMAZON': 'AMZN',
                'NVDA': 'NVDA', 'NVIDIA': 'NVDA',
                'META': 'META', 'FACEBOOK': 'META'
            };
            
            for (const word of words) {
                if (stockMappings[word]) {
                    return stockMappings[word];
                }
            }
            
            return null;
        }

        function addToWatchlist(symbol, currentPrice) {
            if (!watchlist.find(item => item.symbol === symbol)) {
                watchlist.push({ 
                    symbol, 
                    dateAdded: new Date().toLocaleDateString(),
                    addedPrice: currentPrice || 0
                });
                updateWatchlist();
                showNotification(`${symbol} added to your live watchlist!`, 'success');
            } else {
                showNotification(`${symbol} is already in your watchlist!`, 'warning');
            }
        }

        async function updateWatchlist() {
            const watchlistDiv = document.getElementById('watchlist');
            
            if (watchlist.length === 0) {
                watchlistDiv.innerHTML = '<p style="text-align: center; color: #94a3b8; font-style: italic;">Your watchlist is empty. Search and add stocks above to track them live!</p>';
                return;
            }

            let html = '';
            
            for (const item of watchlist) {
                try {
                    const response = await fetch(`${API_BASE}/stock/${item.symbol}`);
                    const stock = await response.json();
                    
                    if (stock && !stock.error) {
                        const changeClass = stock.change >= 0 ? 'status-positive' : 'status-negative';
                        const changeSymbol = stock.change >= 0 ? '+' : '';
                        const gainLoss = stock.price - item.addedPrice;
                        const gainLossPercent = item.addedPrice > 0 ? ((gainLoss / item.addedPrice) * 100).toFixed(2) : '0.00';
                        const gainLossClass = gainLoss >= 0 ? 'status-positive' : 'status-negative';
                        const dataSourceClass = stock.source === 'polygon.io' ? 'real-data' : 'simulated-data';
                        
                        html += `
                            <div class="stock-item">
                                <div class="stock-header">
                                    <span class="stock-symbol">${item.symbol}</span>
                                    <span class="stock-price">${stock.price.toFixed(2)}</span>
                                </div>
                                <p style="margin-bottom: 10px; color: #94a3b8; font-weight: 500;">${stock.name}</p>
                                <div class="stock-details">
                                    <div>Change: <span class="${changeClass}">${changeSymbol}${stock.change.toFixed(2)}</span></div>
                                    <div>Change %: <span class="${changeClass}">${changeSymbol}${stock.changePercent.toFixed(2)}%</span></div>
                                    <div>Since Added: <span class="${gainLossClass}">${gainLoss > 0 ? '+' : ''}${gainLoss.toFixed(2)}</span></div>
                                    <div>Gain/Loss %: <span class="${gainLossClass}">${gainLoss > 0 ? '+' : ''}${gainLossPercent}%</span></div>
                                    <div>Volume: ${formatNumber(stock.volume)}</div>
                                    <div>Added: ${item.dateAdded}</div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button onclick="getLiveAnalysis('${item.symbol}')" class="btn btn-primary">AI Analysis</button>
                                    <button onclick="removeFromWatchlist('${item.symbol}')" class="btn btn-secondary">Remove</button>
                                </div>
                                
                                <div class="data-source-indicator ${dataSourceClass}">
                                    ${stock.source === 'polygon.io' ? '🔴 Live data from Polygon.io' : '🟡 Simulated data'} • ${new Date(stock.lastUpdated).toLocaleTimeString()}
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error(`Error fetching data for ${item.symbol}:`, error);
                }
            }

            watchlistDiv.innerHTML = html || '<p style="text-align: center; color: #94a3b8; font-style: italic;">Error loading watchlist data. Please try refreshing.</p>';
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(item => item.symbol !== symbol);
            updateWatchlist();
            showNotification(`${symbol} removed from watchlist!`, 'success');
        }

        function loadWatchlist() {
            watchlist = [
                { symbol: 'AAPL', dateAdded: new Date().toLocaleDateString(), addedPrice: 170.00 }
            ];
            updateWatchlist();
        }

        function refreshWatchlist() {
            if (watchlist.length > 0) {
                updateWatchlist();
            }
        }

        function getLiveAnalysis(symbol) {
            document.getElementById('aiSearchInput').value = `What do you think about ${symbol} stock right now?`;
            askLiveAI();
        }

        function showModal(content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const contentDiv = document.createElement('div');
            contentDiv.style.cssText = `
                background: rgba(30, 41, 59, 0.98);
                border-radius: 20px;
                border: 1px solid rgba(100, 255, 218, 0.3);
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                width: 100%;
            `;
            
            contentDiv.innerHTML = content;
            modal.appendChild(contentDiv);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            currentModal = modal;
        }

        function closeModal() {
            if (currentModal) {
                document.body.removeChild(currentModal);
                currentModal = null;
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(45deg, #ef4444, #dc2626)';
                    break;
                case 'warning':
                    notification.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(45deg, #64ffda, #00bcd4)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>